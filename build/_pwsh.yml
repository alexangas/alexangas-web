parameters:
  - name: verb
    displayName: 'Type of command'
    type: string
    default: "--version"
  - name: source
    displayName: 'Source path'
    type: string
  - name: destination
    displayName: 'Destination path'
    type: string
  - name: destinationsas
    displayName: 'Destination path SAS'
    type: string
  - name: flags
    displayName: 'Additional flags'
    type: string

steps:
  - task: PowerShell@2
    name: azcopy_Windows
    condition: eq(variables['Agent.OS'], 'Windows_NT')
    inputs:
      pwsh: true
      targetType: 'inline'
      script: |
        '_ScriptDebugStart_' | Out-Null
        $_scriptText = Get-Content -Raw $PSCommandPath
        Write-Host "* Arguments ($($args.count)): $args`r`n$($args | Out-String)"
        Write-Host "* Bound parameters:`r`n$($PSBoundParameters | Out-String)"
        Write-Host "* Script text:"
        Write-Host $($_scriptText -replace '(?ms)''_ScriptDebugStart_.+_ScriptDebugEnd_''[\s|]+\w+\-\w+')
        '_ScriptDebugEnd_' | Out-Null
        Invoke-WebRequest 'https://aka.ms/downloadazcopy-v10-windows' -OutFile './azcopy.zip'
        Expand-Archive './azcopy.zip' -Force
        $azCopy = Get-ChildItem 'azcopy*' -Recurse -File | Where-Object { $_.FullName -like '*azcopy_win*' } | Select-Object $_.FullName
        $z = Get-ChildItem ${{ parameters.source }} -Recurse
        $z
        Write-Host $z
        Start-Process -FilePath $azCopy -Wait -NoNewWindow -ArgumentList '${{ parameters.verb }}','${{ parameters.source }}','${{ parameters.destination }}${{ parameters.destinationsas }}','${{ parameters.flags }}'

  - task: PowerShell@2
    name: azcopy_Linux
    condition: eq(variables['Agent.OS'], 'Linux')
    inputs:
      pwsh: true
      targetType: 'inline'
      script: |
        '_ScriptDebugStart_' | Out-Null
        $_scriptText = Get-Content -Raw $PSCommandPath
        Write-Host "* Arguments ($($args.count)): $args`r`n$($args | Out-String)"
        Write-Host "* Bound parameters:`r`n$($PSBoundParameters | Out-String)"
        Write-Host "* Script text:"
        Write-Host $($_scriptText -replace '(?ms)''_ScriptDebugStart_.+_ScriptDebugEnd_''[\s|]+\w+\-\w+')
        '_ScriptDebugEnd_' | Out-Null
        Invoke-WebRequest 'https://aka.ms/downloadazcopy-v10-linux' -OutFile './azcopy.tar.gz'
        tar -zxf './azcopy.tar.gz'
        $azCopy = Get-ChildItem 'azcopy*' -Recurse -File | Where-Object { $_.FullName -like '*azcopy_linux*' } | Select-Object $_.FullName
        $z = Get-ChildItem ${{ parameters.source }} -Recurse
        $z
        Write-Host $z
        Start-Process -FilePath $azCopy -Wait -NoNewWindow -ArgumentList "${{ parameters.verb }}","${{ parameters.source }}","${{ parameters.destination }}${{ parameters.destinationsas }}","${{ parameters.flags }}"
