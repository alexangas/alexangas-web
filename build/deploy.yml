resources:
  pipelines:
  - pipeline: alexangasweb
    source: alexangas.alexangas-web-ci
    trigger: 
      branches:
      - master

jobs:
  - job: Deploy
    timeoutInMinutes: 10
    cancelTimeoutInMinutes: 0
    pool:
      vmImage: 'windows-latest'
    steps:
      - task: DownloadBuildArtifacts@0
        displayName: "Download build artifacts"
        inputs:
          buildType: 'specific'
          project: '$(ProjectId)'
          pipeline: '$(ProjectDefinition)'
          specificBuildWithTriggering: true
          buildVersionToDownload: 'latestFromBranch'
          branchName: 'refs/heads/master'
          downloadType: 'single'
          artifactName: 'drop'
          downloadPath: '$(System.ArtifactsDirectory)'
      - task: PowerShell@2
        displayName: "Download azcopy"
        inputs:
          targetType: 'inline'
          script: |
            Invoke-WebRequest "https://aka.ms/downloadazcopy-v10-windows" -OutFile "./azcopy.zip"
            Expand-Archive "./azcopy.zip" -DestinationPath "./azcopy"
            $azCopyFullPath = $(Get-ChildItem azcopy -Recurse -Path "./azcopy").FullName
            echo "##vso[task.setvariable variable=azCopyFullPath]$azCopyFullPath"
          pwsh: true
      - task: PowerShell@2
        displayName: "Sync to storage account"
        inputs:
          targetType: 'inline'
          script: |
            Start-Process -FilePath "azcopy" -WorkingDirectory $env:azCopyFullPath -Wait -ArgumentList "sync '$(System.ArtifactsDirectory)/drop' 'https://$(Storage).blob.core.windows.net/`$web/$(SasToken)' --recursive --delete-destination=true"
          pwsh: true
